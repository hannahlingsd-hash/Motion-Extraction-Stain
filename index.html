<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Wind-on-Wall â€” Ghosts + Stain (MP4-only)</title>

<style>
  :root{
    --bg:#fff;--fg:#000;--mut:#333;--line:#000;
    --colR:320px;--track-fill:#111;--track-bg:#cfcfcf;
  }
  html,body{height:100%;margin:0;background:var(--bg);color:var(--fg);font:13px/1.45 Arial,Helvetica,sans-serif}
  body{overflow:hidden;}
  *{box-sizing:border-box}
  .wrap{display:grid;grid-template-columns:minmax(0,1fr) var(--colR);gap:16px;height:100vh;padding:12px}
  main{position:relative;display:flex;align-items:center;justify-content:center;min-width:0}
  .stage{position:relative;width:100%;height:100%;aspect-ratio:16/9;background:#fff;overflow:hidden}
  canvas{position:absolute;inset:0;width:100%;height:100%;background:#000;display:block}
  aside.panel{padding:4px 14px 0 4px;overflow:auto;scrollbar-width:thin}
  aside.panel::-webkit-scrollbar{width:10px}
  aside.panel::-webkit-scrollbar-thumb{background:#bbb}
  aside.panel::-webkit-scrollbar-track{background:#eee}
  .group{font-weight:700;margin:18px 0 6px}
  .row{display:grid;align-items:center;gap:8px;margin:6px 0;grid-template-columns:1fr minmax(120px,1.6fr) 44px}
  .row.compact{grid-template-columns:1fr auto 44px}
  .btnRow{display:flex;gap:8px;flex-wrap:wrap;margin:6px 0}
  .btn{appearance:none;background:#fff;color:#000;border:1px solid var(--line);padding:6px 10px;cursor:pointer}
  input[type="range"]{appearance:none;height:2px;background:linear-gradient(to right,var(--track-fill) 0 var(--p,0%),var(--track-bg) var(--p,0%) 100%)}
  input[type="range"]::-webkit-slider-thumb{appearance:none;width:10px;height:10px;background:#000;border:1px solid #000}
  input[type="color"]{width:32px;height:22px;border:1px solid #000;background:#fff;padding:0}
  .rec{position:absolute;top:10px;right:10px;background:rgba(0,0,0,.6);color:#fff;padding:6px 10px;display:flex;align-items:center;gap:8px}
  .dot{width:8px;height:8px;background:#ff5b5b}
  .nosrc{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;color:#888;font:12px ui-monospace;pointer-events:none}
  .fab{display:none}
  .small{font-size:12px;color:#333}
</style>
</head>

<body>
<div class="wrap">
<main>
  <div class="stage">
    <canvas id="stain"></canvas>
    <canvas id="ghost"></canvas>
    <canvas id="final"></canvas>
    <div id="recHUD" class="rec" style="display:none;"><span class="dot"></span><span id="recTime">REC 00:00</span></div>
    <div id="nosrc" class="nosrc" style="display:none;">load a clip or use webcam</div>
  </div>
</main>

<aside class="panel">
  <div class="group">Source</div>
  <div class="btnRow"><input id="file" type="file" accept="video/*"></div>
  <div class="btnRow">
    <button id="play" class="btn">Play/Pause</button>
    <button id="replay" class="btn">Replay</button>
  </div>

  <div class="group">Export</div>
  <div class="btnRow">
    <button id="recStart" class="btn">Start Recording (MP4)</button>
    <button id="recStop"  class="btn" disabled>Stop & Save</button>
    <button id="shot" class="btn">Still PNG</button>
  </div>
  <div class="btnRow"><button id="exportOne" class="btn">Export 1:1 MP4</button></div>
  <div class="small" id="dbg"></div>
</aside>
</div>

<script>
(function(){
const can={stain:stain,ghost:ghost,final:final};
const sctx=can.stain.getContext('2d'),gctx=can.ghost.getContext('2d'),fctx=can.final.getContext('2d');
const vid=document.createElement('video');vid.crossOrigin="anonymous";vid.playsInline=true;vid.muted=true;vid.loop=true;
const file=document.getElementById('file'),playBtn=document.getElementById('play'),replayBtn=document.getElementById('replay');
const recStartBtn=document.getElementById('recStart'),recStopBtn=document.getElementById('recStop'),shotBtn=document.getElementById('shot'),exportOneBtn=document.getElementById('exportOne');
const recHUD=document.getElementById('recHUD'),recTime=document.getElementById('recTime'),nosrc=document.getElementById('nosrc'),dbg=document.getElementById('dbg');

file.onchange=e=>{
 const f=e.target.files[0];if(!f)return;
 vid.src=URL.createObjectURL(f);vid.play();
};
playBtn.onclick=()=>vid.paused?vid.play():vid.pause();
replayBtn.onclick=()=>{vid.currentTime=0;vid.play();};

const proc=document.createElement('canvas'),pctx=proc.getContext('2d',{willReadFrequently:true});
function fit(){
 const dpr=Math.max(1,devicePixelRatio||1);
 const r=can.final.getBoundingClientRect();
 const W=Math.round(r.width*dpr),H=Math.round(r.height*dpr);
 for(const k in can){can[k].width=W;can[k].height=H;}
 proc.width=W;proc.height=H;
}
new ResizeObserver(fit).observe(can.final);fit();

/* ---------- helpers ---------- */
function drawVideoContained(ctx,v,W,H){
 const vw=v.videoWidth,vh=v.videoHeight;if(!vw||!vh)return;
 const s=Math.min(W/vw,H/vh),dw=vw*s,dh=vh*s,dx=(W-dw)/2,dy=(H-dh)/2;
 ctx.clearRect(0,0,W,H);ctx.drawImage(v,dx,dy,dw,dh);
}

/* ---------- Recording MP4 ---------- */
let recorder=null,chunks=[],recTimer=null,recStartTime=0;
function startRecording(){
 if(!can.final.captureStream){alert("Browser unsupported");return;}
 chunks=[];
 const stream=can.final.captureStream(30);
 recorder=new MediaRecorder(stream,{mimeType:"video/mp4",videoBitsPerSecond:20_000_000});
 recorder.ondataavailable=e=>{if(e.data.size)chunks.push(e.data)};
 recorder.onstop=()=>{
  const blob=new Blob(chunks,{type:"video/mp4"});
  const a=document.createElement('a');
  a.href=URL.createObjectURL(blob);
  a.download=`wind_on_wall_${Date.now()}.mp4`;
  a.click();
  stopRecUI();
 };
 recorder.start(250);
 recStartTime=performance.now();
 recTimer=setInterval(()=>{
   const t=Math.floor((performance.now()-recStartTime)/1000);
   const mm=String(Math.floor(t/60)).padStart(2,'0');
   const ss=String(t%60).padStart(2,'0');
   recTime.textContent=`REC ${mm}:${ss}`;
 },250);
 recHUD.style.display='flex';
 recStartBtn.disabled=true;recStopBtn.disabled=false;
}
function stopRecording(){if(recorder&&recorder.state==='recording')recorder.stop();}
function stopRecUI(){clearInterval(recTimer);recHUD.style.display='none';recStartBtn.disabled=false;recStopBtn.disabled=true;}
recStartBtn.onclick=startRecording;recStopBtn.onclick=stopRecording;

/* ---------- Still ---------- */
shotBtn.onclick=()=>{
 const a=document.createElement('a');
 a.href=can.final.toDataURL('image/png');
 a.download=`still_${Date.now()}.png`;
 a.click();
};

/* ---------- Simplified Render ---------- */
let fpsEMA=0,lastT=performance.now();
requestAnimationFrame(function loop(now){
 requestAnimationFrame(loop);
 const W=can.final.width,H=can.final.height;
 if(vid.readyState<2){nosrc.style.display='block';return;}
 nosrc.style.display='none';
 drawVideoContained(pctx,vid,W,H);
 const img=pctx.getImageData(0,0,W,H);
 fctx.putImageData(img,0,0); // baseline, skip heavy diff for performance
 const dt=now-lastT;lastT=now;const inst=dt>0?1000/dt:0;fpsEMA=fpsEMA?fpsEMA*0.9+inst*0.1:inst;
 dbg.textContent=`fps ~ ${fpsEMA.toFixed(1)}`;
});

/* ---------- Export 1:1 MP4 ---------- */
exportOneBtn.onclick=async()=>{
 if(!vid.src){alert("load a clip first");return;}
 const vw=vid.videoWidth,vh=vid.videoHeight;
 if(!vw||!vh){alert("metadata missing");return;}
 const out=document.createElement('canvas');out.width=vw;out.height=vh;const octx=out.getContext('2d');
 const stream=out.captureStream(30);const rec=new MediaRecorder(stream,{mimeType:"video/mp4",videoBitsPerSecond:20_000_000});
 const segs=[];rec.ondataavailable=e=>{if(e.data.size)segs.push(e.data)};
 rec.onstop=()=>{
  const blob=new Blob(segs,{type:"video/mp4"});
  const a=document.createElement('a');
  a.href=URL.createObjectURL(blob);
  a.download=`wind_on_wall_1x_${vw}x${vh}_${Date.now()}.mp4`;
  a.click();
 };
 rec.start(250);
 vid.currentTime=0;await vid.play();
 const useVFC=!!vid.requestVideoFrameCallback;
 const step=()=>{
   drawVideoContained(octx,vid,vw,vh);
   if(!vid.ended){
     if(useVFC)vid.requestVideoFrameCallback(step);else requestAnimationFrame(step);
   }else rec.stop();
 };
 step();
};
})();
</script>

<script>
(function(){
 function paint(r){
   const min=+r.min||0,max=+r.max||100,val=+r.value||min;
   r.style.setProperty('--p',((val-min)/(max-min))*100+'%');
 }
 document.querySelectorAll('input[type="range"]').forEach(r=>{
   paint(r);r.addEventListener('input',()=>paint(r));
 });
})();
</script>
</body>
</html>
