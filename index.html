<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Wind-on-Wall â€” Ghosts + Stain (hi-res)</title>
<style>
  :root{
    --bg:#fff;--fg:#000;--mut:#333;--line:#000;
    --colR:320px;--track-fill:#111;--track-bg:#cfcfcf;
  }
  html,body{height:100%;margin:0;background:var(--bg);color:var(--fg);font:13px/1.45 Arial,Helvetica,sans-serif}
  body{overflow:hidden;}
  *{box-sizing:border-box}
  .wrap{display:grid;grid-template-columns:minmax(0,1fr)var(--colR);gap:16px;height:100vh;padding:12px;overflow:hidden}
  main{position:relative;display:flex;align-items:center;justify-content:center}
  .stage{position:relative;width:100%;height:100%;aspect-ratio:16/9;background:#fff;overflow:hidden}
  canvas{position:absolute;inset:0;width:100%;height:100%;object-fit:contain;background:#000;display:block}
  aside.panel{padding:4px 14px 0 4px;overflow:auto;scrollbar-width:thin}
  aside.panel::-webkit-scrollbar{width:10px}
  aside.panel::-webkit-scrollbar-thumb{background:#bbb}
  aside.panel::-webkit-scrollbar-track{background:#eee}
  .group{font-weight:700;margin:18px 0 6px}
  .row{display:grid;align-items:center;gap:8px;margin:6px 0;grid-template-columns:1fr minmax(120px,1.6fr) 44px}
  .row.compact{grid-template-columns:1fr auto 44px}
  .btn{appearance:none;background:#fff;color:#000;border:1px solid var(--line);padding:6px 10px;cursor:pointer}
  input[type="range"]{appearance:none;height:2px;background:linear-gradient(to right,var(--track-fill) 0 var(--p,0%),var(--track-bg) var(--p,0%) 100%)}
  input[type="range"]::-webkit-slider-thumb{appearance:none;width:10px;height:10px;background:#000;border:1px solid #000}
  input[type="color"]{width:32px;height:22px;border:1px solid #000;background:#fff;padding:0}
</style>
</head>
<body>
<div class="wrap">
  <main>
    <div class="stage">
      <canvas id="stain"></canvas>
      <canvas id="ghost"></canvas>
      <canvas id="final"></canvas>
    </div>
  </main>

  <aside class="panel">
    <!-- ... all your existing UI unchanged ... -->
    <div class="group">Haunt Map</div>
    <div class="row compact"><label>Enable haunt map</label><input id="hauntOn" type="checkbox"></div>
    <div class="row"><label>Persistence</label><input id="hauntPersist" type="range" min="0" max="1" step="0.01" value="0.85"><span id="hauntPersistV">0.85</span></div>
    <div class="row"><label>Reinforce radius (px)</label><input id="hauntRadius" type="range" min="10" max="60" step="1" value="30"><span id="hauntRadiusV">30</span></div>
    <div class="row"><label>Stickiness</label><input id="hauntStick" type="range" min="0" max="2" step="0.1" value="1.3"><span id="hauntStickV">1.3</span></div>
    <div class="row compact"><label>Haunt color</label><input id="hauntColor" type="color" value="#4a5e8a"></div>
  </aside>
</div>

<script>
/* ... all prior setup code identical ... */

/* ---------- Haunt Map (sharp long-term memory) ---------- */
function drawHauntSharp(fctx, hauntCtx, recallCanvas, hauntCanvas, hauntColor, hauntPersist, hauntStick){
  const p     = Math.max(0, Math.min(1, +hauntPersist.value || 0.85));
  const stick = +hauntStick.value || 1.3;
  const tint  = (hauntColor && hauntColor.value) ? hauntColor.value : '#4a5e8a';
  const decayOut = 0.3 * p;

  // fade existing memory
  hauntCtx.globalCompositeOperation='destination-out';
  hauntCtx.fillStyle=`rgba(0,0,0,${decayOut})`;
  hauntCtx.fillRect(0,0,hauntCanvas.width,hauntCanvas.height);

  // reinforce from recall (sharp)
  hauntCtx.save();
  hauntCtx.globalCompositeOperation='source-over';
  hauntCtx.globalAlpha=Math.min(1,0.55*stick);
  hauntCtx.drawImage(recallCanvas,0,0);
  hauntCtx.restore();

  // subtle multiply tint preserves edges
  hauntCtx.save();
  hauntCtx.globalCompositeOperation='multiply';
  hauntCtx.globalAlpha=0.15;
  hauntCtx.fillStyle=tint;
  hauntCtx.fillRect(0,0,hauntCanvas.width,hauntCanvas.height);
  hauntCtx.restore();

  // composite to final
  fctx.globalCompositeOperation='screen';
  fctx.drawImage(hauntCanvas,0,0);
  fctx.globalCompositeOperation='source-over';
}

/* ---------- main loop (fragment showing usage) ---------- */
function renderFrame(){
  // ... all your existing drawing up to recalls ...
  if(hauntOn && hauntOn.checked){
    drawHauntSharp(fctx, hauntCtx, recallCanvas, hauntCanvas, hauntColor, hauntPersist, hauntStick);
  }
}

/* ---------- export path uses the same helper ---------- */
function renderFrameExport(){
  // ... identical logic, call same helper ...
  if(hauntOn && hauntOn.checked){
    drawHauntSharp(fctx, hauntCtx, recallCanvas, hauntCanvas, hauntColor, hauntPersist, hauntStick);
  }
}
</script>

<script>
(function(){
  function paint(r){var min=+r.min||0,max=+r.max||100,val=+r.value||min,p=((val-min)/(max-min))*100;r.style.setProperty('--p',p+'%')}
  document.querySelectorAll('input[type="range"]').forEach(r=>{paint(r);r.addEventListener('input',()=>paint(r))})
})();
</script>
</body>
</html>
