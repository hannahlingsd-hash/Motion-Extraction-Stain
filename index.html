<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Wind-on-Wall — Ghosts (separate) + Stain (hi-res)</title>
<style>
  /* ====== TOKENS (monochrome, Arial) ====== */
  :root{
    --bg:#fff;           /* page background */
    --fg:#000;           /* text color */
    --mut:#333;          /* secondary text */
    --line:#000;         /* 1px lines */
    --pad:8px;
    --gap:8px;
    --colL:280px;        /* left column width */
    --colR:360px;        /* right column width */
  }
  html,body{height:100%;margin:0;background:var(--bg);color:var(--fg);font:13px/1.45 Arial, Helvetica, sans-serif}
  *{box-sizing:border-box}
  button,input,select{font:inherit;color:var(--fg)}
  /* No roundness anywhere */
  *{border-radius:0}

  /* ====== LAYOUT ====== */
  .wrap{
    display:grid;
    grid-template-columns: var(--colL) 1fr var(--colR);
    gap:16px;
    height:100vh;
    padding:12px 12px 12px 12px;
  }
  aside.controls{padding:0}
  main{position:relative;display:flex;align-items:center;justify-content:center}

  /* Center stage: canvas not full-bleed */
  .stage{
    position:relative;
    width:min(72%, 980px);           /* smaller than middle column */
    aspect-ratio:16/9;               /* keeps a stable box; canvas fits within */
    margin:auto;
    outline:1px solid #0000;         /* invisible; tweak to #000 if you want a hairline frame */
  }

  /* Canvases still fill the stage (unchanged IDs for JS) */
  canvas{position:absolute;inset:0;width:100%;height:100%;object-fit:contain;background:#000}

  /* Right panel groups (no rectangles; spaced) */
  .panel{padding:0 0 4px 0}
  .group{font-weight:700;margin:18px 0 6px} /* bold, not caps */
  .row{
    display:grid;
    grid-template-columns: 1fr minmax(120px,1.6fr) 44px; /* label | slider | readout */
    align-items:center;
    gap:8px;
    margin:6px 0;
  }
  .row.compact{grid-template-columns:auto auto} /* for checkboxes etc. */
  .row label{color:var(--fg)}
  .small{font-size:12px;color:var(--mut)}

  /* Left column rows */
  .leftRows{display:grid;gap:10px}
  .btnRow{display:flex;gap:8px;flex-wrap:wrap}

  /* Buttons: flat, 1px black border, white bg, square corners */
  .btn{
    appearance:none;
    background:#fff;
    color:#000;
    border:1px solid var(--line);
    padding:6px 10px;
    cursor:pointer;
  }
  .btn:disabled{opacity:.5;cursor:not-allowed}
  .btn.secondary{background:#fff}

  /* Sliders: thin track + square thumb; always horizontal */
  input[type="range"]{appearance:none;height:2px;background:#000;outline:none}
  input[type="range"]::-webkit-slider-thumb{appearance:none;width:10px;height:10px;background:#000;border:1px solid #000}
  input[type="range"]::-moz-range-thumb{width:10px;height:10px;background:#000;border:1px solid #000}
  input[type="range"]::-moz-range-track{height:2px;background:#000}
  input[type="color"]{width:32px;height:22px;border:1px solid #000;background:#fff;padding:0}

  /* HUD + REC chips (unchanged behavior; keep legible on white) */
  .hud{position:absolute;top:10px;left:10px;background:rgba(0,0,0,.5);color:#fff;padding:6px 8px;font:12px/1.2 ui-monospace;white-space:pre}
  .rec{position:absolute;top:10px;right:10px;background:rgba(0,0,0,.6);color:#fff;padding:6px 10px;display:flex;align-items:center;gap:8px}
  .dot{width:8px;height:8px;background:#ff5b5b;border-radius:50%;box-shadow:0 0 8px #ff5b5b}
  .nosrc{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;color:#888;font:12px ui-monospace;pointer-events:none}

  /* Floating replay button kept (same id) but we’ll hide by default (you still have the left replay). */
  .fab{position:absolute;top:46px;right:10px;z-index:5;border:1px solid #000;background:#fff;color:#000;padding:6px 10px;cursor:pointer;display:none}
  /* Debug/support lines on left, keep IDs for JS */
  .note{margin-top:6px}
</style>
</head>
<body>
<div class="wrap">
  <!-- ===== LEFT: Source/Playback + Export ===== -->
  <aside class="controls">
    <div class="leftRows">
      <!-- Source row -->
      <div class="btnRow">
        <input id="file" type="file" accept="video/*">
        <button id="webcam" class="btn">Webcam</button>
      </div>
      <!-- Playback row (Replay placed to the right) -->
      <div class="btnRow">
        <button id="play"   class="btn secondary">Play/Pause</button>
        <button id="replay" class="btn secondary">Replay</button>
      </div>

      <!-- Export header (no box, just spacing) -->
      <div class="group">Export</div>
      <div class="row">
        <label>Format</label>
        <select id="format">
          <option value="mp4">MP4 (preferred)</option>
          <option value="webm">WebM</option>
          <option value="auto" selected>Auto (best available)</option>
        </select>
        <span></span>
      </div>
      <div class="btnRow">
        <button id="recStart" class="btn">Start Recording</button>
        <button id="recStop"  class="btn" disabled>Stop &amp; Save</button>
      </div>
      <div class="btnRow">
        <button id="shot" class="btn secondary">Export PNG</button>
        <button id="exportOne" class="btn">Export 1:1 (source)</button>
        <label style="align-self:center">Match preview</label>
        <input id="matchPreview" type="checkbox" checked>
      </div>
      <div class="note small" id="supportNote"></div>
      <div class="note small" id="dbg">buffer: 0 | fps —</div>
    </div>
  </aside>

  <!-- ===== CENTER: Canvas Stage (smaller, centered) ===== -->
  <main>
    <div class="stage">
      <canvas id="stain"></canvas>
      <canvas id="ghost"></canvas>
      <canvas id="final"></canvas>
      <div id="hud" class="hud"></div>
      <div id="recHUD" class="rec" style="display:none;"><span class="dot"></span><span id="recTime">REC 00:00</span></div>
      <div id="nosrc" class="nosrc" style="display:none;">load a clip or use the webcam</div>
      <button id="replayFloat" class="fab" title="Replay (R)">↺</button>
    </div>
  </main>

  <!-- ===== RIGHT: Parameters (spaced groups, bold headers) ===== -->
  <aside class="panel">
    <!-- TEMPORAL WINDOW -->
    <div class="group">Temporal window</div>
    <div class="row"><label>Δt (seconds)</label><input id="dt" type="range" min="2" max="10" step="0.5" value="6"><span id="dtV">6.0</span></div>
    <div class="row"><label>Diff threshold</label><input id="thr" type="range" min="4" max="60" value="18"><span id="thrV">18</span></div>
    <div class="row"><label>Grey level</label><input id="grey" type="range" min="60" max="200" value="120"><span id="greyV">120</span></div>
    <div class="row"><label>Pre-blur (px)</label><input id="preblur" type="range" min="0" max="3" value="0"><span id="preblurV">0</span></div>

    <!-- GHOSTS -->
    <div class="group">Ghosts</div>
    <div class="row"><label>Ghost opacity</label><input id="gAlpha" type="range" min="0" max="1" step="0.05" value="0.7"><span id="gAlphaV">0.70</span></div>
    <div class="row">
      <label>Blend mode</label>
      <select id="gBlend">
        <option value="normal">Normal</option>
        <option value="screen" selected>Screen</option>
        <option value="lighter">Lighter (Add)</option>
        <option value="multiply">Multiply</option>
        <option value="difference">Difference</option>
      </select>
      <span></span>
    </div>
    <div class="row compact">
      <label>Use custom color</label>
      <input id="gUseColor" type="checkbox">
      <input id="gColor" type="color" value="#ffffff">
    </div>

    <!-- STAIN -->
    <div class="group">Stain</div>
    <div class="row compact"><label>Enable stain</label><input id="stainOn" type="checkbox" checked></div>
    <div class="row"><label>Decay</label><input id="decay" type="range" min="0.90" max="0.995" step="0.001" value="0.970"><span id="decayV">0.970</span></div>
    <div class="row"><label>Strength</label><input id="strength" type="range" min="0.1" max="1" step="0.05" value="0.50"><span id="strengthV">0.50</span></div>
    <div class="row"><label>Expand (px)</label><input id="expand" type="range" min="0" max="8" step="1" value="2"><span id="expandV">2</span></div>
    <div class="row compact"><label>Stain color</label><input id="sColor" type="color" value="#223b7a"></div>

    <!-- RECALLS -->
    <div class="group">Recalls</div>
    <div class="row compact"><label>Enable recall</label><input id="recallOn" type="checkbox"></div>
    <div class="row"><label>Recall probability</label><input id="recallProb" type="range" min="0" max="1" step="0.01" value="0.20"><span id="recallProbV">0.20</span></div>
    <div class="row"><label>Recall capacity</label><input id="recallCap" type="range" min="0" max="120" step="5" value="40"><span id="recallCapV">40</span></div>
    <div class="row compact"><label>Recall color</label><input id="recallColor" type="color" value="#00e7ff"></div>
    <div class="row"><label>Linger (s)</label><input id="recallLinger" type="range" min="0.2" max="3" step="0.1" value="1.2"><span id="recallLingerV">1.2</span></div>
    <div class="row"><label>Span (s)</label><input id="recallSpan" type="range" min="0" max="3" step="0.1" value="0.8"><span id="recallSpanV">0.8</span></div>
    <div class="btnRow"><button id="recallNow" class="btn">Recall now</button></div>
  </aside>
</div>

<!-- ===== SCRIPT: UNCHANGED FUNCTIONALITY (exactly your previous JS) ===== -->
<script>
/* (All the JavaScript from your last working version goes here verbatim.)
   I did not modify or remove any logic or IDs. */
</script>
</body>
</html>
